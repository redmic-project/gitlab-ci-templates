variables:
  BUILDING_IMAGE: ${MAVEN_IMAGE_NAME}:${MAVEN_IMAGE_TAG}
  MAVEN_OPTS: -Dmaven.repo.local=.m2/repository
  SPRING_PROFILES_ACTIVE: test
  TEST_COVERAGE_XPATH: //table[@id='coveragetable']/tfoot//td[@class='ctr2'][1]/text()

.maven-build:
  image: ${BUILDING_IMAGE}
  cache:
    paths:
      - .m2/repository/
  script:
    - mvn -pl :${MAVEN_PROJECT_NAME} -U -B clean ${MAVEN_GOALS}
    - coveragePath="${PROJECT_ROOT_PATH}/${TEST_OUTPUT_PATH}/site/jacoco/index.html"
    - >
      if [ -f "${coveragePath}" ];
      then
        coverage=$(xmllint --html --xpath "${TEST_COVERAGE_XPATH}" "${coveragePath}");
        echo "Coverage - ${coverage}";
      fi

  after_script:
    - rm -rf .m2/repository/es
  only:
    - branches
  artifacts:
    name: '${MAVEN_PROJECT_NAME}-${CI_COMMIT_REF_NAME}'
    expire_in: '6 months'
    paths:
      - ${PROJECT_ROOT_PATH}/${BUILD_OUTPUT_PATH}/*.jar
