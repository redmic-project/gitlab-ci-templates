include:
  - local: '/_deployment.yml'

.deploy:
  variables:
    SERVICES_TO_CHECK: ${CI_PROJECT_NAME}_${CI_PROJECT_NAME}-${FUNCTIONAL_UNIT_MICROSERVICE_NAME}

.deploy-commands:
  extends: .deploy
  variables:
    FUNCTIONAL_UNIT_MICROSERVICE_NAME: commands
    STATUS_CHECK_DELAY: 300

.deploy-view:
  extends: .deploy
  variables:
    FUNCTIONAL_UNIT_MICROSERVICE_NAME: view

.deploy-microservice:
  environment: &deploy-microservice-environment
    url: https://${PUBLIC_HOSTNAME}/api/${CI_PROJECT_NAME}/${FUNCTIONAL_UNIT_MICROSERVICE_NAME}

.deploy-microservice-development:
  extends: .deploy-development
  variables:
    COMPOSE_FILE: docker-compose.${CI_PROJECT_NAME}-${FUNCTIONAL_UNIT_MICROSERVICE_NAME}.tmpl.yml:docker-compose.${CI_PROJECT_NAME}-${FUNCTIONAL_UNIT_MICROSERVICE_NAME}.dev.yml
    SPRING_PROFILES_ACTIVE: pre
    DD_SPRING_PROFILES_ACTIVE: pre
  environment:
    name: dev/${CI_PROJECT_NAME}-${FUNCTIONAL_UNIT_MICROSERVICE_NAME}
    <<: *deploy-microservice-environment

.deploy-microservice-production:
  extends: .deploy-production
  variables:
    COMPOSE_FILE: docker-compose.${CI_PROJECT_NAME}-${FUNCTIONAL_UNIT_MICROSERVICE_NAME}.tmpl.yml:docker-compose.${CI_PROJECT_NAME}-${FUNCTIONAL_UNIT_MICROSERVICE_NAME}.prod.yml
    SPRING_PROFILES_ACTIVE: prod
    DD_SPRING_PROFILES_ACTIVE: prod
  environment:
    name: pro/${CI_PROJECT_NAME}-${FUNCTIONAL_UNIT_MICROSERVICE_NAME}
    <<: *deploy-microservice-environment

.deploy-commands-development:
  extends:
    - .deploy-commands
    - .deploy-microservice-development

.deploy-commands-production:
  extends:
    - .deploy-commands
    - .deploy-microservice-production

.deploy-view-development:
  extends:
    - .deploy-view
    - .deploy-microservice-development

.deploy-view-production:
  extends:
    - .deploy-view
    - .deploy-microservice-production
